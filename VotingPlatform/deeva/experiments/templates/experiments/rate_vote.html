{% extends "base.html" %}

{% load bootstrap3 %}
{% load staticfiles %}

{% block content %}

	Progress: {{current_vote}} of {{wizard.number_of_votes}}
	
	<!-- individual content -->
	<div class="row">
		
		{% for content_name in wizard.generation.experiment.content_list %}
		<div class="col-sm-12 col-md-12 text-center">
			<img class="img-responsive img-vote" style="width:10cm;" src="{% url 'experiments:send_individual_content' individual.id content_name %}" alt="{{content_name}} of individual #{{individual.id}}">
		</div>
		{% endfor %}
	</div>

	<!-- fake form for the user -->
	<div class="text-center">
		<form id="fake-form" class="">
			
			{% for vg in dependent_variables_table %}
			<table class="table table-striped text-center" style="font-size:12pt;padding:5pt;">
				
				<thead>
				<tr>
					<th></th>
					{% for label in vg.header %}
					<th>{{label}}</th>
					{% endfor %}
					<th></th>
				</tr>
				</thead>
				<tbody>
					{% for vr in vg.vrs %}
					<tr>
						<td>{{vr.variable.left}}</td>
						{% for label in vg.header %}
						<td><input type="radio" data-variable-id="{{vr.variable.id}}" data-label="{{label}}" id='{{vr.variable.id}}-{{label}}' name="var{{vr.variable.id}}"></td>
						{% endfor %}
						<td>{{vr.variable.right}}</td>

					</tr>
					{% endfor %}
				</tbody>
				
			</table>
			{% endfor %}

		</form>

		<button id="fake-send-btn-click" type="button" class="btn btn-primary">
			<span class="fa fa-chevron-right"></span> Save &amp; Continue
		</button>
		<button id="fake-send-btn-spinner" type="button" class="btn btn-warning disabled d-none">
			<span class="fa fa-pulse fa-spinner"></span> Saving...
		</button>
		<button id="fake-send-btn-finished" type="button" class="btn btn-success disabled d-none">
			<span class="fa fa-check"></span> Saved! Loading next page...
		</button>
	</div>












		
	<!-- real form to submit -->
	<div class="d-none">
		<form action="" method="post" autocomplete="off" id="real-form">
		    {% csrf_token %}
		    {{ formset.as_p }}
		    <input type="submit" value="Submit" />
		</form>
	</div>
	

         
{% endblock %}



{% block scripts %}
	<script>
		$("#fake-form")[0].reset(); //reset fake form on page load

		$("#fake-form").change(function() {
			//get total number of variables to fill and iterate through them
			var total_forms = $('input[name=form-TOTAL_FORMS]').val();

			for (i = 0; i < total_forms; i++) {

				//get variable id for current form
				vid = $('#id_form-'+i+'-variable').val();

				//get selected label from the fake form
				var label = $('input[name=var'+vid+']:checked', '#fake-form').data('label');
				
				//paste value in real form
				$('#id_form-'+i+'-text_value').val(label);
			} ;

		});


		$("#fake-send-btn-click").click(function() {
			var form = $("#real-form");
		    var url = form.attr('action');

		    $('#fake-send-btn-click').addClass("d-none");
		    $('#fake-send-btn-spinner').removeClass("d-none");

		    $.ajax({
		           type: "POST",
		           url: url,
		           data: form.serialize(),
		        }).done(function(data){
		        	if(data.success){
		        		//proceed
		        		$('#fake-send-btn-spinner').addClass("d-none");
		    			$('#fake-send-btn-finished').removeClass("d-none");
		    			window.location.href = "{% url 'experiments:vote' wizard.id %}";
		        	} else {
		        		//re-do form
		        		$('#fake-send-btn-spinner').addClass("d-none");
		    			$('#fake-send-btn-click').removeClass("d-none");
		    			alert("Please fill out the form before clicking on continue.");
		        	}
		        	
		        }).fail(function(jqXHR, textStatus, errorThrown){
		        	$('#fake-send-btn-spinner').addClass("d-none");
		    		$('#fake-send-btn-click').removeClass("d-none");
		        	alert(textStatus);
		        })
		});



		


	</script>
{% endblock %}	


